<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Physik-Spiel Prototyp â€“ 5er-Linien (Magnetismus) v9</title>
  <style>
    :root{
      --panel: rgba(17,24,39,.92);
      --border: rgba(148,163,184,.22);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --shadow: 0 22px 70px rgba(0,0,0,.65);
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;}
    body{
      min-height:100vh;display:flex;align-items:center;justify-content:center;padding:12px;
      background:
        radial-gradient(circle at 15% 10%, rgba(56,189,248,.18), transparent 55%),
        radial-gradient(circle at 85% 15%, rgba(34,197,94,.12), transparent 58%),
        radial-gradient(circle at 80% 90%, rgba(239,68,68,.14), transparent 58%),
        linear-gradient(180deg, #0b1220, #020617);
      color:var(--text);overflow:hidden;
    }
    .app{
      width:min(460px, 100%);height:min(860px, 100dvh);
      background: rgba(17,24,39,.92);
      border:1px solid var(--border);border-radius:22px;box-shadow: var(--shadow);
      overflow:hidden;display:flex;flex-direction:column;
    }
    .top{padding:12px 12px 10px;border-bottom:1px solid rgba(148,163,184,.16);}
    .brand{font-size:.75rem; letter-spacing:.18em; text-transform:uppercase; color:rgba(148,163,184,.95);}
    h1{font-size:1.1rem; margin-top:4px; font-weight:900;}
    .sub{margin-top:6px; color:var(--muted); font-size:.90rem; line-height:1.35;}
    .wordRow{margin-top:10px;display:flex;gap:6px;justify-content:center;align-items:center;flex-wrap:wrap;}
    .letter{
      width:24px;height:24px;border-radius:8px;display:flex;align-items:center;justify-content:center;
      font-weight:900;background: rgba(2,6,23,.40);border:1px solid rgba(148,163,184,.18);
      color: rgba(229,231,235,.9);
    }
    .letter.on{
      background: linear-gradient(135deg, rgba(56,189,248,.95), rgba(251,191,36,.95));
      border-color: rgba(248,250,252,.55);color:#0b1220;box-shadow: 0 10px 30px rgba(56,189,248,.18);
    }
    .wordBtn{
      border:none;border-radius:999px;padding:.48rem .8rem;font-weight:900;letter-spacing:.08em;text-transform:uppercase;
      background: linear-gradient(135deg, rgba(251,191,36,.95), rgba(56,189,248,.95));
      color:#0b1220;box-shadow: 0 14px 40px rgba(56,189,248,.18);cursor:pointer;
    }
    .game{padding:10px 12px 14px;display:flex;flex-direction:column;gap:10px;flex:1;min-height:0;}
    .hud{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    .pill{
      border:1px solid rgba(148,163,184,.22);background: rgba(2,6,23,.34);border-radius:999px;
      padding:.30rem .6rem;font-size:.88rem;color: rgba(229,231,235,.95);
      display:inline-flex;gap:.45rem;align-items:center;white-space:nowrap;
    }
    .pill b{color: rgba(251,191,36,.95)}
    .gridWrap{
      flex:1;min-height:0;display:flex;align-items:center;justify-content:center;
      padding:8px;border-radius:18px;background: rgba(2,6,23,.32);border:1px solid rgba(148,163,184,.16);
    }
    canvas{
      width:100%;height:100%;max-height: 60dvh;display:block;border-radius:14px;
      background: rgba(15,23,42,.55);border:1px solid rgba(148,163,184,.14);
      touch-action:none;outline:none;
    }
    .hint{text-align:center;color: var(--muted);font-size:.92rem;line-height:1.35;padding-top:6px;display:flex;flex-direction:column;gap:6px;align-items:center;justify-content:center;}
    .gestures{display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap;opacity:.95;}
    .gesture{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.20);background: rgba(2,6,23,.30);font-weight:900;color: rgba(229,231,235,.92);white-space:nowrap;}
    .gesture .ic{width:26px;height:26px;border-radius:10px;display:flex;align-items:center;justify-content:center;background: rgba(148,163,184,.14);}

    .startOverlay{position:fixed; inset:0;display:flex;align-items:center;justify-content:center;padding:16px;background: rgba(0,0,0,.55);z-index: 50;}
    .startCard{width:min(520px, 100%);background: rgba(2,6,23,.92);border:1px solid rgba(148,163,184,.28);border-radius:22px;box-shadow: var(--shadow);padding:16px;text-align:center;}
    .startCard h2{margin:0 0 6px;font-size:1.15rem;font-weight:1000;}
    .startCard p{margin:0 0 12px;color: rgba(148,163,184,.95);line-height:1.35;}
    .bigBtn{border:none;border-radius:999px;padding:.75rem 1.1rem;font-weight:1000;letter-spacing:.08em;text-transform:uppercase;background: linear-gradient(135deg, rgba(251,191,36,.95), rgba(56,189,248,.95));color:#0b1220;cursor:pointer;}
    .smallRow{margin-top:10px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .toggle{
      border:1px solid rgba(148,163,184,.25);background: rgba(15,23,42,.45);
      color: rgba(229,231,235,.95);border-radius:999px;padding:.55rem .85rem;font-weight:900;cursor:pointer;
    }
    .toggle.on{
      border-color: rgba(56,189,248,.55);
      box-shadow: 0 10px 28px rgba(56,189,248,.14);
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div class="brand">Physik App Â· Probespiel Â· 5er-Linien</div>
      <h1>Level 1: Magnetismus</h1>
      <div class="sub"><b>Regel:</b> 5 gleiche Blasen in einer Linie = âœ… â†’ <b>1 Buchstabe</b>. (Waagerecht + Senkrecht + Diagonal.)</div>
      <div class="wordRow" id="wordRow"></div>
    </div>

    <div class="game">
      <div class="hud">
        <div class="pill">Buchstaben: <b id="rowsText">0</b>/11</div>
        <div class="pill">Spalten: <b id="colsText">8</b></div>
        <div class="pill">Linie: <b>5</b></div>
      </div>

      <div class="gridWrap">
        <canvas id="cv" width="360" height="600" aria-label="Spiel"></canvas>
      </div>

      <div class="hint">
        <div class="gestures">
          <div class="gesture"><span class="ic">ðŸ‘ˆðŸ‘‰</span></div>
          <div class="gesture"><span class="ic">ðŸ‘‡</span></div>
          <div class="gesture"><span class="ic">ðŸ‘†</span></div>
          <div class="gesture"><span class="ic">ðŸ”Š</span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="startOverlay" id="startOverlay">
    <div class="startCard">
      <h2>Startbereit?</h2>
      <p>Ziel: Sammle Buchstaben fÃ¼r <b>MAGNETISMUS</b> durch 5er-Linien gleicher Blasen.</p>
      <div class="smallRow">
        <button class="toggle on" id="soundToggle" type="button">Sound: AN</button>
      </div>
      <div class="smallRow">
        <button class="bigBtn" id="startBtn" type="button">Start</button>
      </div>
      <p style="margin-top:10px; font-size:.85rem; color: rgba(148,163,184,.95)">
        Tipp: Wenn iOS stumm ist, hÃ¶rst du nichts (Stumm-Schalter). Sonst klapptâ€™s nach dem Start-Tap.
      </p>
    </div>
  </div>

  <script>
    const COLS = 8, ROWS = 10, LINE = 5;
    const TARGET = "MAGNETISMUS";
    const ALLOW_DIAGONAL = true;

    const BUBBLES = [
      {id:"MAG", icon:"ðŸ§²", hue: 145},
      {id:"ELE", icon:"âš¡", hue: 48},
      {id:"LIG", icon:"ðŸ’¡", hue: 35},
      {id:"BAT", icon:"ðŸ”‹", hue: 115},
      {id:"PL1", icon:"",   hue: 210},
      {id:"PL2", icon:"",   hue: 265},
    ];

    const cv = document.getElementById("cv");
    const ctx = cv.getContext("2d");
    const rowsText = document.getElementById("rowsText");
    document.getElementById("colsText").textContent = String(COLS);
    const wordRow = document.getElementById("wordRow");

    const startOverlay = document.getElementById("startOverlay");
    const startBtn = document.getElementById("startBtn");
    const soundToggle = document.getElementById("soundToggle");

    let grid = Array.from({length: ROWS}, () => Array.from({length: COLS}, () => null));
    let current = null; // {col,row,displayY,bubble}
    let letters = 0;
    let running = false;
    let softDrop = false;

    // clearing (kept minimal for prototype)
    let clearingCells = new Set();
    let clearUntilTs = 0;

    // ===== Sound (simple WebAudio) =====
    let soundOn = true;
    let audioCtx = null;

    function ensureAudio(){
      if(!soundOn) return;
      if(!audioCtx){
        try{ audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        catch(e){ audioCtx = null; }
      }
      if(audioCtx && audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
    }
    function beep(freq=520, dur=0.06, type="sine", gain=0.06){
      if(!soundOn) return;
      ensureAudio();
      if(!audioCtx) return;
      const t0 = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      osc.type = type;
      osc.frequency.value = freq;
      g.gain.setValueAtTime(gain, t0);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
      osc.connect(g); g.connect(audioCtx.destination);
      osc.start(t0); osc.stop(t0 + dur);
    }
    const sMove = () => beep(620, 0.035, "triangle", 0.045);
    const sDrop = () => beep(420, 0.06, "sine", 0.07);
    const sLock = () => beep(300, 0.07, "square", 0.05);

    soundToggle.addEventListener("click", () => {
      soundOn = !soundOn;
      soundToggle.classList.toggle("on", soundOn);
      soundToggle.textContent = soundOn ? "Sound: AN" : "Sound: AUS";
      if(soundOn) ensureAudio();
    });

    function randBubble(){ return BUBBLES[Math.floor(Math.random()*BUBBLES.length)]; }

    function renderWord(){
      wordRow.innerHTML = "";
      for(let i=0;i<TARGET.length;i++){
        const d = document.createElement("div");
        d.className = "letter" + (i < letters ? " on" : "");
        d.textContent = (i < letters) ? TARGET[i] : "";
        wordRow.appendChild(d);
      }
      rowsText.textContent = String(letters);
    }
    renderWord();

    function resizeCanvasToDisplay(){
      const rect = cv.getBoundingClientRect();
      const dpr = Math.min(2, window.devicePixelRatio || 1);
      const w = Math.floor(rect.width * dpr);
      const h = Math.floor(rect.height * dpr);
      if(cv.width !== w || cv.height !== h){ cv.width = w; cv.height = h; }
    }
    function cellSize(){ return Math.min(cv.width / COLS, cv.height / ROWS); }

    function canOccupy(r,c){ return r>=0 && r<ROWS && c>=0 && c<COLS && grid[r][c] === null; }

    function spawn(){
      const c = Math.floor(COLS/2);
      if(grid[0][c]){ reset("Game Over â€“ Neustart"); return; }
      current = {col:c, row:0, displayY:0, bubble: randBubble()};
    }

    function lockCurrent(){
      // snap to exact cell center before locking -> avoids visual "merge"
      current.displayY = current.row;
      grid[current.row][current.col] = current.bubble;
      current = null;
      sLock();
      if(!clearingCells.size) spawn();
    }

    function hardDrop(){
      if(!running || !current || clearingCells.size) return;
      while(true){
        const nr = current.row + 1;
        if(nr < ROWS && canOccupy(nr, current.col)) current.row = nr;
        else break;
      }
      current.displayY = current.row;
      sDrop();
      lockCurrent();
    }

    function setColumnFromX(clientX){
      if(!running || !current || clearingCells.size) return;
      const rect = cv.getBoundingClientRect();
      const x = Math.max(0, Math.min(rect.width - 1, clientX - rect.left));
      const target = Math.max(0, Math.min(COLS-1, Math.floor((x / rect.width) * COLS)));
      while(current.col < target){
        if(canOccupy(current.row, current.col + 1)){ current.col++; sMove(); }
        else break;
      }
      while(current.col > target){
        if(canOccupy(current.row, current.col - 1)){ current.col--; sMove(); }
        else break;
      }
    }

    // ===== Drawing (smaller radius + reduced glow to prevent "merging" look) =====
    function drawGrid(){
      const s = cellSize();
      ctx.save();
      ctx.globalAlpha = 0.18;
      ctx.strokeStyle = "rgba(148,163,184,.25)";
      for(let r=0;r<=ROWS;r++){
        ctx.beginPath(); ctx.moveTo(0, r*s); ctx.lineTo(COLS*s, r*s); ctx.stroke();
      }
      for(let c=0;c<=COLS;c++){
        ctx.beginPath(); ctx.moveTo(c*s, 0); ctx.lineTo(c*s, ROWS*s); ctx.stroke();
      }
      ctx.restore();
    }

    function drawBubbleAt(cx, cy, bubble, radius, glow=1){
      ctx.save();
      ctx.shadowColor = `hsla(${bubble.hue}, 95%, 60%, ${0.35*glow})`;
      ctx.shadowBlur = 10*glow;

      const g = ctx.createRadialGradient(cx - radius*0.35, cy - radius*0.35, radius*0.2, cx, cy, radius*1.1);
      g.addColorStop(0, `hsla(${bubble.hue}, 95%, 92%, 1)`);
      g.addColorStop(0.35, `hsla(${bubble.hue}, 92%, 60%, 1)`);
      g.addColorStop(1, `hsla(${bubble.hue}, 92%, 36%, 1)`);

      ctx.fillStyle = g;
      ctx.beginPath(); ctx.arc(cx, cy, radius, 0, Math.PI*2); ctx.fill();

      ctx.shadowBlur = 0;
      ctx.strokeStyle = "rgba(248,250,252,.40)";
      ctx.lineWidth = Math.max(1, radius*0.06);
      ctx.beginPath(); ctx.arc(cx, cy, radius, 0, Math.PI*2); ctx.stroke();

      ctx.globalAlpha = 0.20;
      ctx.fillStyle = "white";
      ctx.beginPath(); ctx.arc(cx - radius*0.28, cy - radius*0.28, radius*0.20, 0, Math.PI*2); ctx.fill();
      ctx.globalAlpha = 1;

      if(bubble.icon){
        ctx.fillStyle = "rgba(2,6,23,.92)";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.font = `900 ${Math.floor(radius*0.90)}px system-ui, Apple Color Emoji, Segoe UI Emoji`;
        ctx.fillText(bubble.icon, cx, cy+1);
      }
      ctx.restore();
    }

    function draw(){
      resizeCanvasToDisplay();
      ctx.clearRect(0,0,cv.width,cv.height);

      const s = cellSize();
      const radius = s*0.38; // smaller -> visible gap -> no "merge" look

      drawGrid();

      for(let r=0;r<ROWS;r++){
        for(let c=0;c<COLS;c++){
          const b = grid[r][c];
          if(!b) continue;
          drawBubbleAt(c*s + s/2, r*s + s/2, b, radius, 0.80);
        }
      }

      if(current){
        // displayY approaches row, but never exceeds -> ensures it stays centered in its cell visually
        const lerp = 0.22;
        current.displayY = current.displayY + (current.row - current.displayY) * lerp;
        drawBubbleAt(current.col*s + s/2, current.displayY*s + s/2, current.bubble, radius, 1.10);
      }
    }

    // ===== Input =====
    let startX=0, startY=0;
    let downSwipeActive = false;

    cv.addEventListener("pointerdown", (e) => {
      cv.setPointerCapture(e.pointerId);
      ensureAudio();
      startX = e.clientX; startY = e.clientY;
      downSwipeActive = false; softDrop = false;
      setColumnFromX(e.clientX);
    });

    cv.addEventListener("pointermove", (e) => {
      if(!running || !current) return;
      setColumnFromX(e.clientX);
      const dy = e.clientY - startY;
      softDrop = dy > 28;
      downSwipeActive = softDrop;
    });

    cv.addEventListener("pointerup", (e) => {
      const dx = Math.abs(e.clientX - startX);
      const dy = Math.abs(e.clientY - startY);
      const isTap = dx < 10 && dy < 10 && !downSwipeActive;
      softDrop = false; downSwipeActive = false;
      if(isTap) hardDrop();
    });

    // ===== Falling (grid-true) =====
    let fallAccumulator = 0;
    function stepsPerSecond(){
      const base = 1.15;
      const bonus = Math.min(0.65, letters*0.06);
      const normal = base + bonus;
      return softDrop ? normal*6.0 : normal;
    }

    function fallStep(){
      if(!current) return;
      const nr = current.row + 1;
      if(nr < ROWS && canOccupy(nr, current.col)){
        current.row = nr;
      }else{
        lockCurrent();
      }
    }

    let lastTs = 0;
    function loop(ts){
      if(!lastTs) lastTs = ts;
      const dt = Math.min(0.033, (ts - lastTs)/1000);
      lastTs = ts;

      if(running){
        if(!current) spawn();
        fallAccumulator += stepsPerSecond() * dt;
        while(fallAccumulator >= 1){
          fallAccumulator -= 1;
          fallStep();
          if(!current) break;
        }
      }
      draw();
      requestAnimationFrame(loop);
    }

    function reset(msg){
      grid = Array.from({length: ROWS}, () => Array.from({length: COLS}, () => null));
      current = null;
      letters = 0;
      softDrop = false;
      fallAccumulator = 0;
      renderWord();
      if(msg) alert(msg);
    }

    startBtn.addEventListener("click", () => {
      ensureAudio();
      startOverlay.style.display = "none";
      running = true;
      beep(520, 0.06, "sine", 0.08);
    });

    draw();
    requestAnimationFrame(loop);
  </script>
</body>
</html>
